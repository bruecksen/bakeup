{% load django_bootstrap5 %}
{% load i18n %}
{% load thumbnail %}
{% load shop_tags %}
{% load humanize %}
{% load wagtailcore_tags %}

{% if production_day_products %}
<div class="row">
    <div class="col">
        <form method="POST" class="anchor" action="{% url 'shop:redirect-production-day' %}" id="backtag">
            <div class="row align-items-start">
                <div class="col-12 col-lg-8">
                    <div class="row">
                        <div class="col-6 col-md-auto">
                            <label for="select-production-day-date" class="fs-3 fw-bold anchor">Backtag: </label>
                        </div>
                        <div class="col-6 col-md-auto">
                            {% csrf_token %}
                            <div class="input-group">
                                <input id="select-production-day-date" inputmode="none" class="form-control fs-4 fw-bold border-0" data-date="{{ production_day.day_of_sale|date:'d.m.Y' }}'" name="production_day_date">
                                <span class="input-group-text fs-3 fw-bold border-0 l-h1 bg-white"><i class="fa-solid fa-calendar-days"></i></span>
                            </div>
                        </div>
                    </div>
                    <div class="row mt-2 production-day-description">
                        <div class="col">
                            {% if production_day.description %}
                            <p class="mb-4 mb-4 lead">{{ production_day.description|safe|linebreaksbr|urlize }}</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
                <div class="col-4">
                    {% include "shop/includes/basket.html" %}
                    {% if not user.is_authenticated %}
                    <div class="card bg-primary text-white" >
                        <div class="card-body">
                            <h4 class="card-title hyphens-auto fw-bold" id="current-order">Brotkorb</h4>
                            <p>Um bestellen zu können musst du dich zuerst <a href="{% url 'shop:login' %}" class="text-white fw-bold">anmelden</a> oder <a href="{% url 'shop:signup' %}" class="text-white fw-bold">registrieren</a>.</p>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </form>
    </div>
</div>
{% if user.is_authenticated %}
    <div class="modal fade checkout-modal" id="checkout" tabindex="-1" aria-labelledby="checkoutModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                <h1 class="modal-title fs-4 fw-bold" id="checkoutModalLabel">
                    {% if current_customer_order %}
                    Bestellung<span class="d-none"> ändern</span>
                    {% else %}
                    Bestellung prüfen
                    {% endif %}
                </h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p class="mb-1">Backtag: <strong>{{ production_day }}</strong></p>
                    <form id="customer-order-form" method="POST" action="{% url 'shop:customer-order-add' production_day=production_day.pk %}">
                        {% csrf_token %}
                        {% if next_url %}
                        <input type="hidden" name="next_url" value="{{ next_url }}">
                        {% endif %}
                    <p class="">Abholort: <select class="form-select form-select-xs d-inline pos-select pe-3 me-1" name="point_of_sale">
                        {% for point_of_sale in point_of_sales %}
                        <option value="{{ point_of_sale.pk }}" {% if current_customer_order.point_of_sale == point_of_sale %} selected{% endif %}>{{ point_of_sale }}</option>
                        {% endfor %}
                        </select></p>
                    <table class="table table-light mt-4 mb-4">
                        <thead>
                            <tr>
                            <th scope="col">Menge</th>
                            <th scope="col">Brot</th>
                            <th scope="col"></th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for product in production_day_products %}
                            <tr class="{% if not product.ordered_quantity %}d-none{% endif %}" data-product="{{ product.product.pk }}" data-ordered-quantity="{{ product.ordered_quantity|default:'0' }}" data-basket-quantity="0">
                                <th scope="row">
                                    {% max_quantity production_day_next product.product as production_day_product_max_quantity %}
                                    <select class="form-select form-select-xs order-quantity" name="product-{{ product.product.pk }}"{% if product.is_locked %} disabled{% endif %}>
                                        {% for i in production_day_product_max_quantity|times %}
                                        <option value="{{i}}" {% if product.ordered_quantity == i %}selected{% endif %}>{{i}}x</option>
                                        {% endfor %}
                                    </select>
                                </th>
                                <td>
                                    {{ product.product }}
                                </td>
                                <td>
                                    {% if not position.production_plan or not position.production_plan.is_locked %}
                                    <div class="col-2 text-end">
                                        {% if not product.is_locked %}
                                            <button type="button" class="btn btn-link btn-sm btn-delete"><i class="fas fa-trash text-black"></i></button>
                                        {% endif %}
                                    </div>
                                    {% else %}
                                    <div class="col text-end">
                                        {% include "workshop/includes/production_plan_state.html" with production_plan=position.production_plan css_class='bg-light text-dark' %}
                                    </div>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    
                    <div class="form-check{% if current_customer_order %} d-none{% endif %}">
                        <input class="form-check-input" type="checkbox" value="" id="flexCheckDefault" required>
                        <label class="form-check-label" for="flexCheckDefault">
                        Ich habe die <a href="">AGB</a> gelesen
                        </label>
                    </div>
                    {% if not current_customer_order %}
                    <button type="submit" class="btn btn-primary mt-3 mb-3">Jetzt kostenpflichtig bestellen</button>
                    {% else %}
                    <button type="submit" class="btn btn-primary mt-3 mb-3 d-none">Jetzt kostenpflichtig ändern</button>
                    <input type="reset" class="btn btn-outline-primary mt-3 mb-3 d-none" value="Änderungen verwerfen">
                    <button class="btn btn-primary mt-3 mb-3" data-bs-dismiss="modal" aria-label="Close">Schließen</button>
                    {% endif %}
                    </form>
                </div>
            </div>
        </div>
    </div>
{% endif %}
<div class="row gy-4">
    {% for production_day_product in production_day_products %}
    <div class="col-12 col-md-6 col-lg-4">
        {% include "shop/includes/product_card.html" %}
    </div>
    {% endfor %}
</div>
{% endif %}
<script>
     window.addEventListener('DOMContentLoaded', () => {
        var datesEnabled = {{ all_production_days|safe }};
         const elem = document.getElementById('select-production-day-date');
     const datepicker = new Datepicker(elem, {
        format: 'dd.mm.yyyy',
        beforeShowDay: function(date) {
            date_formatted = date.toLocaleDateString('de-de', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
            if (datesEnabled.indexOf(date_formatted) != -1) {
                return {
                classes: 'date-enabled',
                // tooltip: 'Vous pouvez choisir cette date'
                }
            } else {
                return false;
            }
        },    
        }); 
        elem.addEventListener('changeDate', function(e) {
            this.form.submit();
        });
        var addon = document.getElementById('select-production-day-date').nextElementSibling.nextElementSibling;
        addon.addEventListener('click', function(){ datepicker.show()}, false);
    });

</script>
