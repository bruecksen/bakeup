{% extends "workshop/base.html" %}
{% load crispy_forms_tags %}
{% load django_bootstrap5 %}

{% block title %}Send production day reminder{% endblock %}
{% block page_heading %}
Production day reminder <small class="text-muted">{{ object }}</small>
{% endblock %}

{% block page_content %}
{{ form.errors }}
<div class="row">
  <div class="col col-md-10">
    <div class="row">
      <div class="col-6">
        <form method="POST" id="select-message-form" action="{% url 'workshop:reminder-message-redirect' pk=production_day.pk %}">
          {% csrf_token %}
          {% bootstrap_field select_message_form.message %}
        </form>
      </div>
    </div>
      <form class="form-horizontal" method="POST">
      <input type="hidden" name="next" value="{{ next }}" />
      {{ form.production_day.as_hidden }}
      {% csrf_token %}
      <div class="card p-3">
        <div class="row">
          <div class="col">
            {% bootstrap_field form.point_of_sale %}
          </div>
          <div class="col">
          </div>
        </div>
        <div class="row">
          <div class="col">
            {% bootstrap_field form.subject %}
          </div>
          <div class="col">
            <label for="email-subject" class="form-label">Subject:</label>
            <input class="form-control" id="email-subject" readonly disabled>
          </div>
        </div>
        <div class="row">
          <div class="col">
            {% bootstrap_field form.body %}
          </div>
          <div class="col">
            <label for="email-body" class="form-label">Send email to:</label>
            <textarea class="form-control" id="email-body" rows="10" readonly disabled></textarea>
          </div>
        </div>
        <div class="row">
          <div class="col">
            <a class="btn btn-outline-primary" href="{% url 'workshop:production-day-detail' pk=production_day.pk %}">Back</a>
            <button type="submit" class="btn btn-outline-primary" name="save"><i class="far fa-save"></i> Save reminder</button>
            <button type="submit" class="btn btn-primary" id="send-emails-button" name="send"><i class="fas fa-paper-plane"></i> Send reminder emails</button>
          </div>
        </div>
      </div>
    </form>
  </div>
</div>
<div class="row mt-4">
  <div class="col">
    <h2>Message History</h2>
  </div>
</div>
<div class="row">
  <div class="col-sm-8 col">
    {% for message in messages_sent %}
    <div class="card p-3 mt-3">
      <div class="row">
        <div class="col">
          <h4>{{ message }}</h4>
          <p class="mb-0">
            <strong>Sent date: </strong>{{ message.sent_date }} <br>
            <strong>Point of sale: </strong>{{ message.point_of_sale|default_if_none:'All' }} <br>
            <strong>Subject: </strong>{{message.subject }}<br>
            <strong>Body: </strong>{{ message.body }}<br>
            <strong>Successfully send: </strong> {{ message.send_log|length }}<br> {{ message.send_log|join:', ' }} <br>
            <strong>Email error: </strong> {{ message.error_log|length }}

            {% if message.error_log %}
            <br>
            {% for email, error in message.error_log.items %} {{ email }}: {{ error }} {% endfor %}<br>
            {% endif %}
          </p>
        </div>
      </div>
    </div>
  {% endfor %}
  </div>
</div>
{{ emails |json_script:"emails" }}
<script type="text/javascript">
  var emails = JSON.parse(document.getElementById('emails').textContent);
  var select = document.getElementById('id_point_of_sale')
  select.addEventListener('change', function() {
    if (this.value) {
      document.getElementById('send-emails-button').innerHTML = "<i class='fas fa-paper-plane'></i> Send " + emails[this.value].length + " reminder emails";
    } else {
      document.getElementById('send-emails-button').innerHTML = "<i class='fas fa-paper-plane'></i> Send " + emails['all'].length + " reminder emails";
    }
  });
  select.dispatchEvent(new Event('change'));

  var source = document.getElementById('id_body');
  var target = document.getElementById('email-body');
  
  source.addEventListener('input', function() {
    var sourceValue = source.value;
    sourceValue = sourceValue.replace(new RegExp("\\{\\{ user \\}\\}","g"), 'Manu Musteruser');
    sourceValue = sourceValue.replace(new RegExp("\\{\\{ client \\}\\}","g"), '{{ request.tenant.name|safe }}');
    sourceValue = sourceValue.replace(new RegExp("\\{\\{ order \\}\\}","g"), '1 x Hasenbrot \n2 x Baguette \n1 x Roggenmisch');
    target.value = sourceValue;
  });
  source.dispatchEvent(new Event('input'));
  var source2 = document.getElementById('id_subject');
  var target2 = document.getElementById('email-subject');
  
  source2.addEventListener('input', function() {
    target2.value = source2.value;
  });
  source2.dispatchEvent(new Event('input'));
</script>
{% endblock %}