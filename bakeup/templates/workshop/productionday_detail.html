{% extends "workshop/base.html" %}
{% load workshop_tags %}
{% load crispy_forms_tags %}
{% load django_bootstrap5 %}
{% load render_table from django_tables2 %}
{% load export_url from django_tables2 %}

{% block title %}Production day{% endblock %}
{% block page_heading %}<span class="d-print-none">Production day <form class="d-inline-block" method="post" action="{% url 'workshop:production-day-next' %}"></span>
  {% csrf_token %}
  <div class="input-group d-print-none">
    <a class="btn btn-outline-primary{% if not production_day_prev %} disabled{% endif %}" type="button" href="{% if production_day_prev %}{% url 'workshop:production-day-detail' pk=production_day_prev.pk %}{% endif %}"><i class="fas fa-chevron-left"></i></a>
    {{ production_day_form.production_day }}
    <a class="btn btn-outline-primary{% if not production_day_next %} disabled{% endif %}" type="button" href="{% if production_day_next %}{% url 'workshop:production-day-detail' pk=production_day_next.pk %}{% endif %}"><i class="fas fa-chevron-right"></i></a>
  </div>
</form>
{% endblock %}
{% block page_heading_action %}
<a href="{% url 'workshop:production-day-add' %}" class="btn btn-primary btn-sm float-end">Add new production day</a>
{% endblock %}

{% block page_content %}
<div class="row">
  <div class="col">
    <div class="btn-group btn-group-sm float-end d-print-none" role="group" aria-label="Basic example">
      <a href="{% url 'workshop:production-day-update' pk=object.pk %}?next={{ object.get_absolute_url }}" class="btn btn-sm btn-primary"><i class="fas fa-edit"></i>Edit</a>
      <a href="{% url 'workshop:production-day-delete' pk=object.pk %}" class="btn btn-sm btn-primary{% if object.is_locked %} disabled{% endif %}"><i class="fas fa-trash-can"></i> Delete</a>
      <a href="{% url 'workshop:order-list' %}?production_day={{ object.pk }}" class="btn btn-sm btn-primary"><i class="fas fa-shopping-basket"></i> Show orders</a>
      <a href="{% url 'workshop:production-plan-production-day' pk=object.pk %}" class="btn btn-sm btn-primary{% if not object.production_plans.exists %} disabled{% endif %}"><i class="fas fa-sliders"></i> Show plans</a>
      <a href="{% url 'workshop:production-day-meta-product' pk=object.pk %}?next={{ object.get_absolute_url }}" class="btn btn-primary"><i class="fas fa-retweet"></i> Abos</a>
      <a href="{% url 'workshop:production-day-reminder' pk=object.pk %}?next={{ object.get_absolute_url }}" class="btn btn-primary"><i class="fas fa-envelope"></i> Reminder</a>
      <a href="{% url 'workshop:order-list' %}?production_day={{ object.pk }}&_export=csv" class="btn btn-primary"><i class="fas fa-file-download"></i> Export as CSV</a>
    </div>
  </div>
</div>
<ul class="nav nav-tabs d-print-none" role="tablist">
  <li class="nav-item" role="presentation">
    <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#summary" type="button" role="tab" aria-controls="summary" aria-selected="true">Summary</button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" data-bs-toggle="tab" data-bs-target="#ingredients" type="button" role="tab" aria-controls="ingredients" aria-selected="false">Ingredients</button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" data-bs-toggle="tab" data-bs-target="#orders" type="button" role="tab" aria-controls="orders" aria-selected="false">Delivery bill</button>
  </li>
</ul>
<div class="tab-content">
  <div class="tab-pane fade show active" id="summary" role="tabpanel" aria-labelledby="summary-tab">
    <p class="mt-4"><strong>Description: </strong> {{ object.description }}</p>
    
    <h2 class="mt-4">Summary
      
      <a href="{% url 'workshop:production-plans-finish' production_day=object.pk %}?next={{ object.get_absolute_url }}" class="btn{% if not has_plans_to_finish %} disabled{% endif %} btn-success btn-sm d-print-none btn-sm float-end me-2"{% if not has_plans_to_finish %} aria-disabled="true"{% endif %}>Finish all</a>
      <a href="{% url 'workshop:production-plans-start' production_day=object.pk %}?next={{ object.get_absolute_url }}" class="btn{% if not has_plans_to_start %} disabled{% endif %} btn-warning btn-sm d-print-none btn-sm float-end me-2"{% if not has_plans_to_start %} aria-disabled="true"{% endif %}>Start all</a>
    </h2>
    <table class="table">
      <tr>
          <th>Product</th>
          <th>Published in shop</th>
          <th>Ordered qty.</th>
          <th>Max qty.</th>
      </tr>
      {% for product in object.production_day_products.all %}
      <tr{% if product.get_order_quantity > product.max_quantity %} class="table-danger"{% endif %}>
          <td><a href="{{ product.product.get_absolute_url }}">{{ product.product }}</a> {% include "workshop/includes/production_plan_state.html" with production_plan=product.production_plan %}</td>
          <td>{% if  product.is_published %}<i class="fa-regular fa-circle-check"></i>{% else %}<i class="far fa-times-circle"></i>{% endif %}</td>
          <td>{{ product.get_order_quantity }}</td>
          <td>{{ product.max_quantity }}</td>
      </tr>
      {% endfor %}
    </table>
    <a href="{% url 'workshop:order-add' pk=object.pk %}?next={{ object.get_absolute_url }}" class="btn btn-primary btn-sm float-end">Edit orders</a>
    <p>Customer ordered quantity: <strong>{{ object.total_published_ordered_quantity }}</strong> (from {{ object.customer_orders.count }} orders)  <br>
      Total ordered quantity: <strong>{{ object.total_ordered_quantity }}</strong>
    </p>
    <h3 class="mt-4">Product Mapping</h3>
    <table class="table">
      <tr>
          <th>Source Product</th>
          <th>Target Product</th>
          <th>Count</th>
      </tr>
      {% for product_mapping in object.product_mapping.all %}
      <tr{% if product.get_order_quantity > product.max_quantity %} class="table-danger"{% endif %}>
          <td>{{ product_mapping.source_product }}</td>
          <td>{{ product_mapping.target_product }}</td>
          <td>{{ product_mapping.matched_count }}</td>
      </tr>
      {% endfor %}
    </table>
  </div>
  <div class="tab-pane fade" id="orders" role="tabpanel" aria-labelledby="orders-tab">
    {% for point_of_sale in point_of_sales %}
    <div class="mt-10 d-print-none"></div>
    <h3 class="mt-4 mb-3 border-bottom border-3">{{ point_of_sale.point_of_sale }} <small class="text-muted float-end">{{ object }}</small></h3>
        <ul class="list-unstyled ml-4">
          {% for order_summary in point_of_sale.summary %}
          <li><span class="quantity">{{ order_summary.quantity }} x</span> {{ order_summary.product__name }}</li>
          {% endfor%}
        </ul>
    <table class="table" style="table-layout: fixed;">
      <tr>
          <th width="">Benutzer</th>
          <th width="70%">Produkte</th>
          <th width="10%" class="text-center">
            Abgeholt
          </th>
      </tr>
      <tr class="d-print-none">
        <td></td>
        <td></td>
        <td class="text-center">
          <button class="btn btn-link"
          hx-get="{% url 'workshop:pos-all-picked-up' production_day=object.pk pos=point_of_sale.point_of_sale.pk %}"
          hx-trigger="click"
          ><i class="far fa-square-check fa-xl"></i></button>
        </td>
      </tr>
      {% for order in point_of_sale.orders %}
      <tr>
          <td>
            {% if request.tenant.clientsetting.show_full_name_delivery_bill %}
            {{ order.customer }}
            {% else %}
            {{ order.customer.user.short_name }}
            {% endif %}
            {% include "workshop/includes/production_plan_state.html" with production_plan=product.production_plan %}</td>
          <td>
            {% include "workshop/includes/order_positions.html" with positions=order.positions.all %}
          </td>
          <td class="text-center">
            <form method="POST">
              {% csrf_token %}
              <input 
              {% if order.is_picked_up %}checked {% endif %}
              class="form-check-input form-input-lg border-dark rounded-0"
              type="checkbox"
              aria-label="is picked up"
              hx-post="{% url 'workshop:order-is-picked-up' pk=order.pk %}"
              hx-trigger="click"
              >
            </form>
          </td>
      </tr>
      {% endfor %}
    </table>
    <div class="pagebreak"></div>

    {% endfor %}
  </div>
  <div class="tab-pane fade" id="ingredients" role="tabpanel" aria-labelledby="ingredients-tab">
    <h2 class="mt-4">Ingredients Summary</h2>
    <table class="table">
      <tr>
          <th>Ingredient</th>
          <th>Amount</th>
      </tr>
      {% for category, products in object.get_ingredient_summary_list.items %}
        <tr class="table-active">
          <td><strong>{{ category.name }}</strong></td>
          <td><strong>{{ products.sum|clever_rounding }} g</strong></td>
        </tr>
        {% for ingredient, quantity in products.items %}
        {% if ingredient != 'sum' %}
          <tr>
            <td>{{ ingredient }}</td>
            <td>{{ quantity|clever_rounding }} {{ ingredient.unit }}</td>
          </tr>
        {% endif %}
        {% endfor %}
      {% endfor %}
    </table>
  </div>
</div>

 

{% endblock %}